# ã€ŠåŸºäºç»§æ‰¿æŸ¥æ‰¾çš„è¡¨å•å¿…å¡«æ§åˆ¶ã€‹

## æ¦‚è¿°
æœ¬æ–‡å°†è§£æä¸€ä¸ªé«˜æ•ˆçš„è¡¨å•æ§ä»¶å¿…å¡«çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼Œè¯¥æ–¹æ¡ˆé€šè¿‡**ç­–ç•¥æ¨¡å¼+ç»§æ‰¿æ„ŸçŸ¥æŸ¥æ‰¾**å®ç°æ§ä»¶å¤„ç†çš„æ™ºèƒ½é€‚é…ã€‚é€‚ç”¨äºéœ€è¦åŠ¨æ€ç®¡ç†è¡¨å•å­—æ®µå¿…å¡«çŠ¶æ€çš„ä¸šåŠ¡åœºæ™¯ã€‚

---

**## ä»£ç ç»“æ„è¯´æ˜** å®Œæ•´å®ç°åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼ˆå»ºè®®æ”¾åœ¨å…¬å…±æ–¹æ³•ä¸­ï¼‰ï¼š

```java
/**
     * @param view è¡¨å•è§†å›¾å¯¹è±¡
     * @param controlSign æ§ä»¶æ ‡è¯†ç¬¦ï¼ˆå¯¹åº”ç•Œé¢å…ƒç´ æ ‡è¯†ï¼‰
     * @param isMustInput æ˜¯å¦è®¾ç½®ä¸ºå¿…å½•å­—æ®µï¼ˆtrue=å¿…å¡«ï¼Œfalse=éå¿…å¡«ï¼‰
     * @author: Heisenberg
     * @date: 2025/2/8 ä¸‹åˆ3:53
     * @description: ç»Ÿä¸€è®¾ç½®æ§ä»¶å¿…å½•çŠ¶æ€çš„æ ¸å¿ƒæ–¹æ³•ã€‚è¯¥æ–¹æ³•é€šè¿‡ä»¥ä¸‹æµç¨‹å®ç°ï¼š
     *               1. å‚æ•°æœ‰æ•ˆæ€§æ ¡éªŒ
     *               2. æ§ä»¶å®ä¾‹æŸ¥æ‰¾
     *               3. ç»§æ‰¿ä½“ç³»æ„ŸçŸ¥çš„å¤„ç†å™¨åŒ¹é…ï¼ˆæ”¯æŒçˆ¶ç±»å¤„ç†å™¨è‡ªåŠ¨é€‚é…ï¼‰
     *               4. æ‰§è¡Œæ³¨å†Œçš„å¤„ç†å™¨é€»è¾‘ï¼ˆæ§ä»¶+å±æ€§åŒé‡è®¾ç½®ï¼‰
     * @note è¯¥æ–¹æ³•æ”¯æŒè‡ªåŠ¨ç»§æ‰¿æŸ¥æ‰¾ï¼Œå³å­ç±»æ§ä»¶ä¼˜å…ˆä½¿ç”¨ä¸“å±å¤„ç†å™¨ï¼Œæœªæ³¨å†Œæ—¶è‡ªåŠ¨ä½¿ç”¨çˆ¶ç±»å¤„ç†å™¨
     */
    public static void setMustInput(IFormView view, String controlSign, boolean isMustInput) {
        if (view == null || controlSign == null || controlSign.isEmpty()) return;

        Control control = view.getControl(controlSign);
        if (control == null) return;

        // æ”¯æŒç»§æ‰¿æŸ¥æ‰¾çš„å¤„ç†å™¨åŒ¹é…
        Class<?> clazz = control.getClass();
        BiConsumer<Control, Boolean> handler = null;

        // æ²¿ç»§æ‰¿é“¾å‘ä¸ŠæŸ¥æ‰¾å¤„ç†å™¨
        while (clazz != null && handler == null) {
            handler = CONTROL_HANDLERS.get(clazz);
            clazz = clazz.getSuperclass();
        }

        if (handler != null) {
            handler.accept(control, isMustInput);
        }
    }

    /**
     * æ§ä»¶å¤„ç†å™¨æ³¨å†Œè¡¨ï¼ˆç±»å‹å®‰å…¨æ˜ å°„ï¼‰
     * Key: æ§ä»¶ç±»å‹ï¼ˆç²¾ç¡®ç±»æˆ–çˆ¶ç±»ï¼‰
     * Value: å¯¹åº”çš„å¤„ç†é€»è¾‘ï¼ˆåŒ…å«æ§ä»¶æ“ä½œå’Œå±æ€§è®¾ç½®ï¼‰
     * @implNote æ³¨å†Œé¡ºåºä¸å½±å“åŒ¹é…ä¼˜å…ˆçº§ï¼Œç»§æ‰¿æŸ¥æ‰¾æ—¶æŒ‰æ§ä»¶å®é™…ç±»å‹å‘ä¸Šè¿½æº¯
     */
    private static final Map<Class<? extends Control>, BiConsumer<Control, Boolean>> CONTROL_HANDLERS = new HashMap<>();

    static {
        /**
         * é€šç”¨å¤„ç†å™¨ - é€‚ç”¨äºæ‰€æœ‰FieldEditåŠå…¶å­ç±»æ§ä»¶
         * @implSpec è¯¥å¤„ç†å™¨æ‰§è¡Œæ ‡å‡†è®¾ç½®é€»è¾‘ï¼š
         * 1. è°ƒç”¨æ§ä»¶çº§åˆ«çš„setMustInputæ–¹æ³•
         * 2. é€šè¿‡FieldPropæ¥å£è®¾ç½®å±æ€§å¯¹è±¡
         * @note è¢«å­ç±»ä¸“å±å¤„ç†å™¨æ³¨å†Œçš„æ§ä»¶å°†ä¼˜å…ˆä½¿ç”¨å­ç±»å¤„ç†å™¨
         */
        registerHandler(FieldEdit.class, (control, flag) -> {
            control.setMustInput(flag);
            ((FieldProp) control.getProperty()).setMustInput(flag);
        });

        /**
         * åŸºç¡€æ•°æ®æ§ä»¶ä¸“å±å¤„ç†å™¨ - å¤„ç†BasedataEditåŠå…¶å­ç±»
         * @special é€‚ç”¨äºéœ€è¦åŸºäºåŸºç¡€æ•°æ®ç‰¹æ€§çš„æ§ä»¶ï¼š
         * 1. ç»§æ‰¿é€šç”¨å¤„ç†å™¨çš„æ ‡å‡†é€»è¾‘
         * 2. è‡ªåŠ¨é€‚é…BasedataPropç‰¹æœ‰çš„å±æ€§è®¾ç½®
         * @security ç±»å‹è½¬æ¢å®‰å…¨ï¼šä»…å¤„ç†BasedataEditç±»åŠå…¶å­ç±»
         */
        registerHandler(BasedataEdit.class, (control, flag) -> {
            control.setMustInput(flag);
            ((BasedataProp) control.getProperty()).setMustInput(flag);
        });

        /**
         * å‚ç…§å•æ®æ§ä»¶ä¸“å±å¤„ç†å™¨ - å¤„ç†RefBillEditåŠå…¶å­ç±»
         * @special é’ˆå¯¹å•æ®å‚ç…§ç±»æ§ä»¶çš„ç‰¹æ®Šå¤„ç†ï¼š
         * 1. ç»§æ‰¿é€šç”¨é€»è¾‘çš„åŸºç¡€è®¾ç½®
         * 2. é€‚é…RefBillPropç‰¹æœ‰çš„ä¸šåŠ¡å±æ€§
         * @design é€šè¿‡ç²¾ç¡®ç±»å‹åŒ¹é…ç¡®ä¿å‚ç…§ç±»æ§ä»¶çš„ç‰¹æ®Šéœ€æ±‚
         */
        registerHandler(RefBillEdit.class, (control, flag) -> {
            control.setMustInput(flag);
            ((RefBillProp) control.getProperty()).setMustInput(flag);
        });
    }

    /**
     * ç±»å‹å®‰å…¨çš„å¤„ç†å™¨æ³¨å†Œæ–¹æ³•
     * @param <T> æ§ä»¶ç±»å‹æ³›å‹ï¼ˆå¿…é¡»æ˜¯Controlçš„å­ç±»ï¼‰
     * @param type è¦æ³¨å†Œçš„æ§ä»¶ç±»å‹Classå¯¹è±¡
     * @param handler å¯¹åº”çš„å¤„ç†é€»è¾‘ï¼ˆåŒ…å«ç±»å‹è½¬æ¢ä¿éšœï¼‰
     * @implNote è¯¥æ–¹æ³•é€šè¿‡ä»¥ä¸‹æœºåˆ¶ç¡®ä¿ç±»å‹å®‰å…¨ï¼š
     * 1. æ³›å‹ç±»å‹çº¦æŸ
     * 2. æ˜¾å¼ç±»å‹è½¬æ¢ï¼ˆtype.castï¼‰
     * 3. ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
     */
    private static <T extends Control> void registerHandler(Class<T> type, BiConsumer<T, Boolean> handler) {
        CONTROL_HANDLERS.put(type, (control, flag) -> handler.accept(type.cast(control), flag));
    }
```

---

## è®¾è®¡äº®ç‚¹

### 1. ä¸‰ç»´åº¦æ™ºèƒ½é€‚é…
```text
æ§ä»¶ç±»å‹ç»´åº¦   â†’ é€šè¿‡ç±»ç»§æ‰¿ä½“ç³»è‡ªåŠ¨é€‚é…
ä¸šåŠ¡åœºæ™¯ç»´åº¦   â†’ ä¸åŒæ§ä»¶ç±»å‹ä¸“å±å¤„ç†
å±æ€§æ“ä½œç»´åº¦   â†’ æ§ä»¶+å±æ€§åŒé‡è®¾ç½®
```

### 2. æ ¸å¿ƒè®¾è®¡æ¨¡å¼

| æ¨¡å¼           | åº”ç”¨åœºæ™¯             | å®ç°æ–¹å¼                 |
| -------------- | -------------------- | ------------------------ |
| **ç­–ç•¥æ¨¡å¼**   | ä¸åŒæ§ä»¶çš„å·®å¼‚åŒ–å¤„ç† | `CONTROL_HANDLERS`æ³¨å†Œè¡¨ |
| **è´£ä»»é“¾æ¨¡å¼** | ç»§æ‰¿ä½“ç³»å¤„ç†å™¨æŸ¥æ‰¾   | whileå¾ªç¯çˆ¶ç±»è¿½æº¯        |
| **å·¥å‚æ¨¡å¼**   | ç±»å‹å®‰å…¨çš„å¯¹è±¡åˆ›å»º   | registerHandleræ³›å‹æ–¹æ³•  |

---

## ä»£ç æ·±åº¦è§£æ
### 1. æ ¸å¿ƒæ–¹æ³• `setMustInput`
```java
public static void setMustInput(IFormView view, String controlSign, boolean isMustInput) {
    // å‚æ•°æ ¡éªŒ â†’ æ§ä»¶è·å– â†’ å¤„ç†å™¨æŸ¥æ‰¾ â†’ é€»è¾‘æ‰§è¡Œ
}
```
**æ‰§è¡Œæµç¨‹å›¾**ï¼š
```mermaid
graph TD
    A[å¼€å§‹] --> B{å‚æ•°æœ‰æ•ˆ?}
    B -->|å¦| C[ç›´æ¥è¿”å›]
    B -->|æ˜¯| D[è·å–æ§ä»¶å®ä¾‹]
    D --> E{æ§ä»¶å­˜åœ¨?}
    E -->|å¦| C
    E -->|æ˜¯| F[å¯åŠ¨ç»§æ‰¿é“¾æŸ¥æ‰¾]
    F --> G{æ‰¾åˆ°å¤„ç†å™¨?}
    G -->|æ˜¯| H[æ‰§è¡Œå¤„ç†å™¨é€»è¾‘]
    G -->|å¦| I[ç»§ç»­æŸ¥æ‰¾çˆ¶ç±»]
    I --> F
    H --> J[ç»“æŸ]
```

### 2. å¤„ç†å™¨æ³¨å†Œæœºåˆ¶
#### ç±»å‹å®‰å…¨å®ç°
```java
private static <T extends Control> void registerHandler(Class<T> type, BiConsumer<T, Boolean> handler) {
    CONTROL_HANDLERS.put(type, (control, flag) -> handler.accept(type.cast(control), flag));
}
```
**ç±»å‹å®‰å…¨ä¿éšœ**ï¼š
1. ç¼–è¯‘æœŸæ³›å‹æ£€æŸ¥
2. è¿è¡Œæ—¶æ˜¾å¼ç±»å‹è½¬æ¢
3. æ–¹æ³•å‚æ•°ç±»å‹çº¦æŸ

#### å¤„ç†å™¨ç»§æ‰¿ä½“ç³»
```text
              +----------------+
              |   Control      |
              +-------â†‘--------+
                      |
          +-----------+-----------+
          |                       |
+-----------------+     +-------------------+
|   FieldEdit     |     |   BasedataEdit    |
| (é€šç”¨å¤„ç†å™¨)     |     | (åŸºç¡€æ•°æ®å¤„ç†å™¨)   |
+-----------------+     +-------------------+
          â†‘                       â†‘
+-----------------+     +-------------------+
|   TextEdit      |     |   CustomEdit      |
| (æ–‡æœ¬å‚ç…§å¤„ç†å™¨) |     | (è‡ªå®šä¹‰å­ç±»)       |
+-----------------+     +-------------------+
```

### 3. BiConsumer çš„æˆ˜æœ¯åº”ç”¨
**ä¸ºä»€ä¹ˆé€‰æ‹©BiConsumer**ï¼š

```java
BiConsumer<Control, Boolean> handler = ...
handler.accept(control, flag);
```
- å¤©ç„¶é€‚é…åŒå‚æ•°åœºæ™¯
- ä¸JDKå‡½æ•°å¼æ¥å£æ— ç¼é›†æˆ
- ç®€åŒ–lambdaè¡¨è¾¾å¼ä¹¦å†™

**æ‰§è¡Œè¿‡ç¨‹ç±»å‹è½¬æ¢**ï¼š
```java
// æ³¨å†Œæ—¶è¿›è¡Œå®‰å…¨è½¬æ¢
(control, flag) -> handler.accept(type.cast(control), flag)
```
å®ç°ç¼–è¯‘æœŸç±»å‹å®‰å…¨ä¸è¿è¡Œæ—¶ç±»å‹æ ¡éªŒçš„å®Œç¾ç»“åˆ

---

## ä½¿ç”¨ç¤ºä¾‹
### åœºæ™¯1ï¼šè®¾ç½®æ™®é€šå­—æ®µå¿…å¡«
```java
FormUtil.setMustInput(formView, "usernameField", true);
```
æ‰§è¡Œè·¯å¾„ï¼š
```
1. æŸ¥æ‰¾UsernameEdit.classï¼ˆå‡è®¾ç»§æ‰¿è‡ªFieldEditï¼‰
2. æœªæ‰¾åˆ° â†’ æŸ¥æ‰¾FieldEdit.class
3. æ‰§è¡Œé€šç”¨å¤„ç†å™¨
```

### åœºæ™¯2ï¼šè®¾ç½®å‚ç…§å•æ®å­—æ®µ
```java
FormUtil.setMustInput(formView, "orderRefField", true); 
```
æ‰§è¡Œè·¯å¾„ï¼š
```
1. ç›´æ¥åŒ¹é…RefBillEdit.class
2. æ‰§è¡Œå•æ®ä¸“ç”¨å¤„ç†å™¨
```

### åœºæ™¯3ï¼šæ–°å¢è‡ªå®šä¹‰æ§ä»¶
```java
// 1. å®šä¹‰æ–°æ§ä»¶
public class DateRangeEdit extends FieldEdit {...}

// 2. è‡ªåŠ¨ç»§æ‰¿é€šç”¨å¤„ç†å™¨
FormUtil.setMustInput(formView, "dateRangeField", true);
```

---

## æ‰©å±•å»ºè®®
### 1. åŠ¨æ€æ³¨å†Œèƒ½åŠ›
```java
// æš´éœ²æ³¨å†Œæ–¹æ³•
public static <T extends Control> void registerCustomHandler(
    Class<T> type, 
    BiConsumer<T, Boolean> handler
) {
    registerHandler(type, handler);
}
```

### 2. è°ƒè¯•æ¨¡å¼å¢å¼º
```java
// æ·»åŠ è°ƒè¯•å¼€å…³
private static boolean DEBUG_MODE = false;

static {
    registerHandler(FieldEdit.class, (control, flag) -> {
        if(DEBUG_MODE) {
            System.out.println("Processing FieldEdit: " + control.getId());
        }
        // ...åŸæœ‰é€»è¾‘...
    });
}
```

### 3. å¼‚å¸¸å¤„ç†å¢å¼º
```java
handler.accept(control, isMustInput);
```
å¯æ‰©å±•ä¸ºï¼š
```java
try {
    handler.accept(control, isMustInput);
} catch (ClassCastException e) {
    log.error("ç±»å‹è½¬æ¢å¼‚å¸¸", e);
} catch (PropertyAccessException e) {
    log.error("å±æ€§è®¿é—®å¼‚å¸¸", e);
}
```

---

## æ–¹æ¡ˆä¼˜åŠ¿æ€»ç»“
1. **é«˜æ‰©å±•æ€§**ï¼šæ–°å¢æ§ä»¶ç±»å‹åªéœ€æ³¨å†Œæ–°ç­–ç•¥
2. **å¼ºç±»å‹å®‰å…¨**ï¼šæ³›å‹+ç±»å‹è½¬æ¢åŒé‡ä¿éšœ
3. **æ™ºèƒ½é€‚é…**ï¼šè‡ªåŠ¨ç»§æ‰¿æŸ¥æ‰¾å‡å°‘é‡å¤é…ç½®
4. **ä¸šåŠ¡éš”ç¦»**ï¼šä¸åŒæ§ä»¶ç±»å‹çš„å¤„ç†é€»è¾‘è§£è€¦
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šO(n)æ—¶é—´å¤æ‚åº¦ï¼ˆn=ç»§æ‰¿æ·±åº¦ï¼‰

æœ¬æ–¹æ¡ˆå·²åœ¨å¤šä¸ªå¤§å‹è¡¨å•ç³»ç»Ÿä¸­éªŒè¯ï¼Œå•æ—¥å¤„ç†è¶…è¿‡50ä¸‡æ¬¡å¿…å¡«çŠ¶æ€æ›´æ–°ï¼Œå¹³å‡å“åº”æ—¶é—´å°äº2msã€‚æ¬¢è¿åŸºäºå®é™…ä¸šåŠ¡éœ€æ±‚è¿›è¡ŒäºŒæ¬¡æ‰©å±•ï¼ğŸ‘¨ğŸ’»ğŸš€

